<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Creativo | Generador de Activos Web con IA</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            /* Tailwind blue-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            /* Gray-800 */
            color: #f3f4f6;
            /* Gray-100 */
            transition: all 0.3s ease;
        }

        .container-card {
            background-color: #374151;
            /* Gray-700 */
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .ai-input-focus:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .image-card {
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            border: 3px solid transparent;
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        .image-card.selected {
            border-color: #facc15;
            /* Tailwind amber-400 */
            box-shadow: 0 0 20px rgba(250, 202, 21, 0.5);
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #f3f4f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Estilo para el checkbox */
        .custom-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .loading-image-placeholder {
            height: 12rem;
            /* h-48 */
            background-color: #4b5563;
            /* Gray-600 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- Encabezado -->
    <header class="text-center mb-8">
        <h1 class="text-5xl font-extrabold tracking-tight text-white mb-2">Nexus Creativo</h1>
        <p class="text-xl text-gray-400">El motor de IA para los activos visuales de tu web.</p>
    </header>

    <!-- Contenedor Principal -->
    <div id="main-app" class="w-full max-w-6xl container-card p-6 sm:p-10">

        <!-- √Årea de Input y Generaci√≥n -->
        <section id="input-section" class="mb-10 p-6 bg-gray-600/50 rounded-xl">
            <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                <i data-lucide="sparkles" class="w-6 h-6 mr-2 text-yellow-400"></i>
                Define el √Åmbito de tu Web
            </h2>
            <form id="generation-form" class="space-y-6">
                <textarea id="theme-input"
                    class="w-full p-4 text-lg bg-gray-700 rounded-lg border-2 border-gray-600 ai-input-focus resize-none text-white placeholder-gray-400"
                    rows="3"
                    placeholder="Ej: Una tienda de velas artesanales inspiradas en viajes por el Mediterr√°neo, con un toque minimalista y tonos tierra."
                    required></textarea>

                <!-- Opciones Avanzadas (Cantidad y Tipos) -->
                <div class="bg-gray-700 p-4 rounded-lg space-y-4">
                    <h3 class="text-xl font-medium text-white flex items-center">
                        <i data-lucide="settings-2" class="w-5 h-5 mr-2 text-blue-300"></i>
                        Opciones Avanzadas
                    </h3>

                    <!-- Cantidad y Estilo -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-grow">
                            <label for="quantity-input" class="block text-sm font-medium text-gray-300 mb-1">Cantidad de
                                Im√°genes (1-8)</label>
                            <input type="number" id="quantity-input" value="4" min="1" max="8" required
                                class="w-full p-3 bg-gray-800 rounded-lg border-2 border-gray-600 ai-input-focus text-white">
                        </div>
                        <div class="flex-grow">
                            <label for="style-select" class="block text-sm font-medium text-gray-300 mb-1">Estilo
                                Visual</label>
                            <select id="style-select"
                                class="w-full p-3 bg-gray-800 rounded-lg border-2 border-gray-600 text-white ai-input-focus">
                                <option value="photo-realistic, high detail">Fotorrealista, Alto Detalle</option>
                                <option value="minimalist, flat design, vector">Minimalista, Dise√±o Plano</option>
                                <option value="sci-fi, neon, cyberpunk">Ciencia Ficci√≥n, Neon</option>
                                <option value="watercolor painting, vibrant colors">Acuarela, Colores Vivos</option>
                                <option value="3D render, soft lighting">Render 3D, Iluminaci√≥n Suave</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tipos de Activos -->
                    <div>
                        <p class="block text-sm font-medium text-gray-300 mb-2">Selecciona los Tipos de Activos a
                            Generar (M√≠nimo 1):</p>
                        <div id="asset-types-container" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- Checkboxes de tipos de activo -->
                            <label
                                class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 p-3 rounded-lg cursor-pointer">
                                <input type="checkbox" name="asset_type" value="Logo" checked
                                    class="custom-checkbox h-5 w-5 rounded focus:ring-blue-500">
                                <span class="text-white">Logo</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 p-3 rounded-lg cursor-pointer">
                                <input type="checkbox" name="asset_type" value="Encabezado" checked
                                    class="custom-checkbox h-5 w-5 rounded focus:ring-blue-500">
                                <span class="text-white">Encabezado</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 p-3 rounded-lg cursor-pointer">
                                <input type="checkbox" name="asset_type" value="Fondo" checked
                                    class="custom-checkbox h-5 w-5 rounded focus:ring-blue-500">
                                <span class="text-white">Fondo / Patr√≥n</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-500 p-3 rounded-lg cursor-pointer">
                                <input type="checkbox" name="asset_type" value="Icono/Producto" checked
                                    class="custom-checkbox h-5 w-5 rounded focus:ring-blue-500">
                                <span class="text-white">Icono / Producto</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de Generaci√≥n -->
                <button type="submit" id="generate-button"
                    class="w-full px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold rounded-lg transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center">
                    <i data-lucide="zap" class="w-6 h-6 mr-2"></i>
                    Generar Activos
                </button>
            </form>
            <p id="error-message" class="text-red-400 mt-3 hidden"></p>
        </section>

        <!-- √Årea de Resultados y Descarga -->
        <section id="results-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-white flex items-center">
                    <i data-lucide="layout-grid" class="w-6 h-6 mr-2 text-blue-400"></i>
                    Resultados de la IA
                </h2>
                <button id="download-selected-button"
                    class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed hidden"
                    disabled>
                    <i data-lucide="download" class="w-5 h-5 inline-block mr-1"></i>
                    Descargar Seleccionadas (0)
                </button>
            </div>

            <!-- Galer√≠a de Im√°genes -->
            <div id="image-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <p id="placeholder-message" class="col-span-full text-center text-gray-500 py-10">
                    Introduce el √°mbito de tu web y haz clic en "Generar" para crear activos visuales.
                </p>
            </div>
        </section>
    </div>

    <!-- Scripts de Firebase (Estructura Requerida) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===============================================
        // CONFIGURACI√ìN FIREBASE (opcional si no usas DB)
        // ===============================================
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth;
        let userId = null;

        setLogLevel('Debug');

        window.onload = async function () {
            try {
                if (Object.keys(firebaseConfig).length) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("‚úÖ Usuario autenticado con UID:", userId);
                        } else {
                            signInAnonymously(auth).then(cred => {
                                userId = cred.user.uid;
                                console.log("‚úÖ Usuario an√≥nimo autenticado:", userId);
                            }).catch(error => console.error("Error auth an√≥nima:", error));
                        }
                    });

                    if (token) await signInWithCustomToken(auth, token);
                } else {
                    console.warn("‚ö†Ô∏è Firebase no configurado. Continuando sin conexi√≥n a DB.");
                    userId = crypto.randomUUID();
                }
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                userId = crypto.randomUUID();
            }
        };

        // ===============================================
        // L√ìGICA PRINCIPAL DE GENERACI√ìN
        // ===============================================
        const API_KEY = typeof __GENERATIVE_LANGUAGE_API_KEY__ !== 'undefined' ? __GENERATIVE_LANGUAGE_API_KEY__ : "";
        const MAX_RETRIES = 5;
        const IMAGE_PREDICT_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict";

        const PROMPT_TEMPLATES = {
            'Logo': "Concepto de logotipo abstracto, composici√≥n centrada, colores vibrantes, simple, fondo blanco, ",
            'Encabezado': "Imagen de encabezado (hero image) para un sitio web, formato panor√°mico 16:9, iluminaci√≥n suave, sin texto, ",
            'Fondo': "Patr√≥n de fondo sutil y repetible, abstracto, ideal para una secci√≥n, seamless, ",
            'Icono/Producto': "Icono o miniatura de producto/servicio, enfoque cercano (close-up), detalles precisos, fondo blanco, "
        };

        let generatedImages = [];

        function updateDownloadButton() {
            const selectedCount = generatedImages.filter(img => img.selected).length;
            const btn = document.getElementById('download-selected-button');
            btn.textContent = `Descargar Seleccionadas (${selectedCount})`;
            btn.disabled = selectedCount === 0;
            btn.classList.toggle('hidden', generatedImages.length === 0);
        }

        function sleep(attempt) {
            const delay = Math.pow(2, attempt) * 100 + Math.random() * 100;
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        async function callImageGenerationAPI(prompt) {
            console.log("üß† Enviando prompt:", prompt);

            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { sampleCount: 1 }
            };

            const apiUrl = `${IMAGE_PREDICT_URL}?key=${API_KEY}`;

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        console.warn("‚è≥ L√≠mite alcanzado, reintentando...");
                        await sleep(attempt);
                        continue;
                    }

                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`Error HTTP ${response.status}: ${text.substring(0, 200)}`);
                    }

                    const result = await response.json();
                    console.log("‚úÖ Respuesta IA:", result);

                    if (result.predictions?.[0]?.bytesBase64Encoded) {
                        return result.predictions[0].bytesBase64Encoded;
                    } else {
                        throw new Error("Respuesta IA vac√≠a o mal formada.");
                    }
                } catch (error) {
                    console.error(`‚ùå Error en intento ${attempt + 1}:`, error);
                    if (attempt === MAX_RETRIES - 1) return null;
                    await sleep(attempt);
                }
            }
            return null;
        }

        function createLoadingCard(name) {
            const gallery = document.getElementById("image-gallery");
            const card = document.createElement("div");
            card.className = "image-card rounded-xl bg-gray-600/50 p-3 flex flex-col transition duration-300 relative";
            card.innerHTML = `
        <div class="loading-image-placeholder">
            <div class="spinner"></div>
        </div>
        <div class="p-2 text-center text-gray-300">Generando: ${name}...</div>
    `;
            gallery.appendChild(card);
            return card;
        }

        function updateCardWithImage(card, base64Image, name, index) {
            const imageUrl = `data:image/png;base64,${base64Image}`;
            card.innerHTML = `
        <div class="absolute top-2 right-2 z-10">
            <input type="checkbox" id="check-${index}" class="custom-checkbox h-6 w-6 rounded focus:ring-amber-500 cursor-pointer transition duration-150 hover:scale-110">
        </div>
        <img src="${imageUrl}" alt="${name}" class="w-full h-48 object-cover rounded-lg mb-3 shadow-md">
        <div class="p-2 text-center text-gray-300 font-medium">${name}</div>
    `;

            const checkbox = card.querySelector(`#check-${index}`);
            checkbox.addEventListener('change', () => {
                const selected = checkbox.checked;
                generatedImages[index].selected = selected;
                card.classList.toggle("selected", selected);
                updateDownloadButton();
            });

            generatedImages[index] = { name, data: base64Image, selected: false };
            updateDownloadButton();
            lucide.createIcons();
        }

        function downloadImage(dataUrl, filename) {
            const a = document.createElement("a");
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function downloadSelectedImages() {
            const selected = generatedImages.filter(img => img.selected);
            if (selected.length === 0) return alert("Selecciona al menos una imagen.");
            selected.forEach((img, i) => {
                const dataUrl = `data:image/png;base64,${img.data}`;
                setTimeout(() => downloadImage(dataUrl, `${img.name.replace(/\W+/g, "_")}_${i + 1}.png`), 400 * i);
            });
        }

        // ===============================================
        // EVENTOS DEL FORMULARIO
        // ===============================================
        async function handleGeneration(event) {
            event.preventDefault();
            event.stopPropagation();

            console.log("üöÄ Iniciando generaci√≥n...");

            const themeInput = document.getElementById("theme-input");
            const styleSelect = document.getElementById("style-select");
            const quantityInput = document.getElementById("quantity-input");
            const errorMessage = document.getElementById("error-message");
            const placeholderMessage = document.getElementById("placeholder-message");
            const generateButton = document.getElementById("generate-button");
            const gallery = document.getElementById("image-gallery");

            generatedImages = [];
            gallery.innerHTML = "";
            placeholderMessage.classList.add("hidden");
            updateDownloadButton();

            const userTheme = themeInput.value.trim();
            const selectedStyle = styleSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const selectedTypes = Array.from(document.querySelectorAll('input[name="asset_type"]:checked')).map(el => el.value);

            if (!userTheme || selectedTypes.length === 0 || quantity < 1 || quantity > 8) {
                errorMessage.textContent = "Por favor completa todas las selecciones y verifica la cantidad.";
                errorMessage.classList.remove("hidden");
                return;
            }

            errorMessage.classList.add("hidden");
            generateButton.disabled = true;

            const tasks = [];
            for (let i = 0; i < quantity; i++) {
                const typeKey = selectedTypes[i % selectedTypes.length];
                const name = `${typeKey} ${i + 1}`;
                const template = PROMPT_TEMPLATES[typeKey];
                tasks.push({
                    prompt: `${template}${userTheme}, estilo: ${selectedStyle}`,
                    name,
                    index: i
                });
            }

            const placeholderCards = tasks.map(t => createLoadingCard(t.name));
            const results = await Promise.all(tasks.map(async (t, i) => {
                const base64Data = await callImageGenerationAPI(t.prompt);
                if (base64Data) {
                    updateCardWithImage(placeholderCards[i], base64Data, t.name, i);
                    return true;
                } else {
                    placeholderCards[i].innerHTML = `
                <div class="loading-image-placeholder bg-red-800/50">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-400"></i>
                </div>
                <div class="p-2 text-center text-red-400 font-medium">Error al generar: ${t.name}</div>
            `;
                    lucide.createIcons();
                    return false;
                }
            }));

            const successful = results.filter(Boolean).length;
            if (successful === 0) {
                placeholderMessage.textContent = "‚ö†Ô∏è La IA no pudo generar ninguna imagen. Intenta un tema o estilo diferente.";
                placeholderMessage.classList.remove("hidden");
            }

            generateButton.disabled = false;
        }

        // ===============================================
        // INICIALIZACI√ìN GLOBAL
        // ===============================================
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            console.log("‚úÖ App lista. Esperando input del usuario...");

            const form = document.getElementById("generation-form");
            const downloadSelectedButton = document.getElementById("download-selected-button");

            if (form) form.addEventListener("submit", handleGeneration);
            if (downloadSelectedButton) downloadSelectedButton.addEventListener("click", downloadSelectedImages);
        });
    </script>
</body>

</html>